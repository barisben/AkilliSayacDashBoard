using AkilliSayac.Areas.Identity.Data;
using AkilliSayac.Data;
using AkilliSayac.Models;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Http.HttpResults;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using NuGet.Versioning;
using System;
using System.Globalization;
using System.Text.RegularExpressions;

namespace AkilliSayac.Data
{
    [Authorize]
    public static class MalwareOperation
    {
        public static void GetMalwaresFromFile(ApplicationDbContext db, IWebHostEnvironment hostingEnvironment)
        {   
            if (db.Malwares.Count() == 0)
            {
                string filePath = Path.Combine(hostingEnvironment.WebRootPath, @"logs/") + "randmalwarelog.txt";
                string pattern = @"(.*)\s-\s(.*)\s-\s(.*)\s-\s(.*)";
                Regex regex = new Regex(pattern);

                if (File.Exists(filePath))
                {
                    string[] lines = File.ReadAllLines(filePath);
                    foreach (string line in lines)
                    {
                        Match match = regex.Match(line);
                        if (match.Success)
                        {
                            string dateString = match.Groups[1].Value;
                            string deviceName = match.Groups[2].Value;
                            string type = match.Groups[3].Value;
                            string message = match.Groups[4].Value;
                            DateTime date = DateTime.ParseExact(dateString, "yyyy-MM-dd HH:mm:ss", CultureInfo.InvariantCulture, DateTimeStyles.None);


                            Malware malware = new Malware();
                            malware.MalwareTime = date;
                            malware.MalwareMessage = message;
                            malware.DeviceId = db.Devices.Where(x => x.DeviceName == deviceName).FirstOrDefault().DeviceId;
                            malware.MalwareTypeId = db.MalwareTypes.Where(x => x.MalwareTypeName == type).FirstOrDefault().MalwareTypeId;

                            db.Malwares.AddAsync(malware);
                        }
                    }
                    db.SaveChanges();
                }
            }
        }
    }
}
